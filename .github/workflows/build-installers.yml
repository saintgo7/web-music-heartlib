# =============================================================================
# MuLa Studio Installer Build Workflow
#
# This workflow builds installers for Windows, macOS, and Linux.
# Triggered on:
#   - Version tags (v*.*.*)
#   - Manual dispatch
#
# Outputs:
#   - MuLa_Setup_x64.exe (Windows 64-bit)
#   - MuLa_Setup_x86.exe (Windows 32-bit)
#   - MuLa_Installer.dmg (macOS Universal)
#   - mula_install.sh (Linux)
# =============================================================================

name: Build Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  PYTHON_VERSION: '3.10.11'

jobs:
  # ===========================================================================
  # Windows x64 Build
  # ===========================================================================
  build-windows-x64:
    name: Windows x64
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install NSIS
        run: |
          choco install nsis -y
          echo "C:\Program Files (x86)\NSIS" >> $GITHUB_PATH

      - name: Download and Extract Python Embedded (x64)
        shell: powershell
        run: |
          $pythonUrl = "https://www.python.org/ftp/python/${{ env.PYTHON_VERSION }}/python-${{ env.PYTHON_VERSION }}-embed-amd64.zip"
          New-Item -ItemType Directory -Force -Path "installer/windows/build"

          Write-Host "Downloading Python embedded package..."
          Invoke-WebRequest -Uri $pythonUrl -OutFile "installer/windows/build/python-embed.zip"

          Write-Host "Extracting Python..."
          New-Item -ItemType Directory -Force -Path "installer/windows/build/python"
          Expand-Archive -Path "installer/windows/build/python-embed.zip" -DestinationPath "installer/windows/build/python" -Force

          Write-Host "Python extracted successfully"
          Get-ChildItem "installer/windows/build/python" | Select-Object Name

      - name: Modify NSIS script to use pre-extracted Python
        shell: powershell
        run: |
          $nsiFile = "installer/windows/MuLaInstaller_x64.nsi"
          $content = Get-Content $nsiFile -Raw

          # Replace nsisunz extraction with SetOutPath and File commands
          $content = $content -replace 'nsisunz::Unzip "\$INSTDIR\\python\\python-embed\.zip" "\$INSTDIR\\python"[\r\n\s]+Delete "\$INSTDIR\\python\\python-embed\.zip"', 'SetOutPath "$INSTDIR\python"`r`n    File /r "build\python\*.*"'

          $content | Set-Content $nsiFile
          Write-Host "Modified NSIS script to use pre-extracted Python files"

      - name: Build NSIS Installer (x64)
        shell: cmd
        run: |
          cd installer\windows
          "C:\Program Files (x86)\NSIS\makensis.exe" /DVERSION=${{ steps.version.outputs.VERSION }} MuLaInstaller_x64.nsi

      - name: Upload Windows x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-installer
          path: installer/windows/MuLa_Setup_x64.exe
          if-no-files-found: error

  # ===========================================================================
  # Windows x86 Build (Optional - CPU only)
  # ===========================================================================
  build-windows-x86:
    name: Windows x86
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install NSIS
        run: choco install nsis -y

      - name: Download and Extract Python Embedded (x86)
        shell: powershell
        run: |
          $pythonUrl = "https://www.python.org/ftp/python/${{ env.PYTHON_VERSION }}/python-${{ env.PYTHON_VERSION }}-embed-win32.zip"
          New-Item -ItemType Directory -Force -Path "installer/windows/build"

          Write-Host "Downloading Python embedded package..."
          Invoke-WebRequest -Uri $pythonUrl -OutFile "installer/windows/build/python-embed.zip"

          Write-Host "Extracting Python..."
          New-Item -ItemType Directory -Force -Path "installer/windows/build/python"
          Expand-Archive -Path "installer/windows/build/python-embed.zip" -DestinationPath "installer/windows/build/python" -Force

          Write-Host "Python extracted successfully"
          Get-ChildItem "installer/windows/build/python" | Select-Object Name

      - name: Create x86 NSIS script
        shell: powershell
        run: |
          # Copy and modify the x64 script for x86
          $content = Get-Content "installer/windows/MuLaInstaller_x64.nsi" -Raw

          # Modify for x86
          $content = $content -replace 'MuLa_Setup_x64.exe', 'MuLa_Setup_x86.exe'
          $content = $content -replace 'python-3.10.11-embed-amd64.zip', 'python-3.10.11-embed-win32.zip'
          $content = $content -replace '\$\{RunningX64\}', '${AtLeastWin7}'
          $content = $content -replace '64-bit Windows only', '32-bit Windows'
          $content = $content -replace 'python310._pth', 'python310._pth'

          # Force CPU mode for x86 (no CUDA)
          $content = $content -replace '\$\{If\} \$GPU_TYPE == "cuda"', '${If} 1 == 0'

          # Replace nsisunz extraction with pre-extracted files
          $content = $content -replace 'nsisunz::Unzip "\$INSTDIR\\python\\python-embed\.zip" "\$INSTDIR\\python"[\r\n\s]+Delete "\$INSTDIR\\python\\python-embed\.zip"', 'SetOutPath "$INSTDIR\python"`r`n    File /r "build\python\*.*"'

          $content | Set-Content "installer/windows/MuLaInstaller_x86.nsi"
          Write-Host "Modified x86 NSIS script to use pre-extracted Python files"

      - name: Build NSIS Installer (x86)
        shell: cmd
        run: |
          cd installer\windows
          "C:\Program Files (x86)\NSIS\makensis.exe" /DVERSION=${{ steps.version.outputs.VERSION }} MuLaInstaller_x86.nsi

      - name: Upload Windows x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86-installer
          path: installer/windows/MuLa_Setup_x86.exe
          if-no-files-found: error

  # ===========================================================================
  # macOS Build
  # ===========================================================================
  build-macos:
    name: macOS Universal
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Make install script executable
        run: chmod +x installer/macos/install.sh

      - name: Verify shell script syntax
        run: bash -n installer/macos/install.sh

      - name: Create app bundle structure
        run: |
          mkdir -p "MuLa Installer.app/Contents/MacOS"
          mkdir -p "MuLa Installer.app/Contents/Resources"

          # Create launcher
          cat > "MuLa Installer.app/Contents/MacOS/install" << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          osascript -e 'tell application "Terminal"
            activate
            do script "\"'"${SCRIPT_DIR}/../Resources/install.sh"'\""
          end tell'
          EOF
          chmod +x "MuLa Installer.app/Contents/MacOS/install"

          # Copy resources
          cp installer/macos/install.sh "MuLa Installer.app/Contents/Resources/"
          cp installer/app/main.py "MuLa Installer.app/Contents/Resources/"
          cp installer/app/download_models.py "MuLa Installer.app/Contents/Resources/"
          chmod +x "MuLa Installer.app/Contents/Resources/install.sh"

          # Create Info.plist
          cat > "MuLa Installer.app/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>install</string>
            <key>CFBundleIdentifier</key>
            <string>kr.abada.mulastudio.installer</string>
            <key>CFBundleName</key>
            <string>MuLa Installer</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ steps.version.outputs.VERSION }}</string>
            <key>CFBundleVersion</key>
            <string>${{ steps.version.outputs.VERSION }}</string>
            <key>LSMinimumSystemVersion</key>
            <string>12.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
          </dict>
          </plist>
          EOF

      - name: Create DMG
        run: |
          create-dmg \
            --volname "MuLa Studio Installer" \
            --window-size 600 400 \
            --icon "MuLa Installer.app" 150 190 \
            --app-drop-link 450 190 \
            --no-internet-enable \
            "MuLa_Installer.dmg" \
            "MuLa Installer.app"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: MuLa_Installer.dmg
          if-no-files-found: error

  # ===========================================================================
  # Linux Build
  # ===========================================================================
  build-linux:
    name: Linux Script
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Linux install script
        run: |
          mkdir -p installer/linux

          # Create comprehensive Linux installer
          cat > installer/linux/mula_install.sh << 'SCRIPT_EOF'
          #!/bin/bash
          #
          # MuLa Studio Installer for Linux
          # Supports: Ubuntu 20.04+, Debian 11+, Fedora 35+, Arch Linux
          #

          set -e

          VERSION="${{ steps.version.outputs.VERSION }}"
          INSTALL_DIR="$HOME/.mulastudio"
          MODEL_DIR="$INSTALL_DIR/models"
          BIN_DIR="$HOME/.local/bin"

          # Colors
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          BOLD='\033[1m'
          NC='\033[0m'

          log() { echo -e "${GREEN}[OK]${NC} $1"; }
          warn() { echo -e "${YELLOW}[!]${NC} $1"; }
          error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }
          step() { echo -e "\n${BLUE}[STEP]${NC} ${BOLD}$1${NC}"; }

          echo -e "${BOLD}"
          echo "================================================================"
          echo "   MuLa Studio Installer v${VERSION}"
          echo "   HeartMuLa AI Music Generator"
          echo "================================================================"
          echo -e "${NC}"

          # System check
          step "Checking system requirements"

          ARCH=$(uname -m)
          if [[ "$ARCH" != "x86_64" ]]; then
              error "Only x86_64 architecture is supported (current: $ARCH)"
          fi
          log "Architecture: $ARCH"

          if [[ -f /etc/os-release ]]; then
              . /etc/os-release
              log "OS: $NAME $VERSION_ID"
          fi

          if ! command -v python3 &> /dev/null; then
              error "Python3 is required. Please install Python 3.10+"
          fi
          PYTHON_VER=$(python3 --version)
          log "Python: $PYTHON_VER"

          if command -v nvidia-smi &> /dev/null; then
              GPU_NAME=$(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null | head -1)
              log "GPU: $GPU_NAME (CUDA enabled)"
              GPU_MODE="cuda"
          else
              warn "No NVIDIA GPU detected - CPU mode (slower)"
              GPU_MODE="cpu"
          fi

          FREE_GB=$(df -BG "$HOME" | awk 'NR==2 {print $4}' | tr -d 'G')
          if [[ "$FREE_GB" -lt 15 ]]; then
              error "Insufficient disk space! Need 15GB (available: ${FREE_GB}GB)"
          fi
          log "Disk space: ${FREE_GB}GB available"

          RAM_GB=$(free -g | awk '/^Mem:/{print $2}')
          log "RAM: ${RAM_GB}GB"

          # Installation
          echo ""
          read -p "Start installation? (This will take 15-30 minutes) [Y/n] " -n 1 -r
          echo
          [[ $REPLY =~ ^[Nn]$ ]] && exit 0

          step "Creating virtual environment"
          mkdir -p "$INSTALL_DIR"
          python3 -m venv "$INSTALL_DIR/venv"
          source "$INSTALL_DIR/venv/bin/activate"
          pip install --upgrade pip wheel setuptools
          log "Virtual environment ready"

          step "Installing PyTorch (${GPU_MODE} mode)"
          if [[ "$GPU_MODE" == "cuda" ]]; then
              pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
          else
              pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          fi
          log "PyTorch installed"

          step "Installing dependencies"
          pip install gradio huggingface_hub tqdm requests
          pip install git+https://github.com/saintgo7/web-music-heartlib.git
          log "Dependencies installed"

          step "Downloading AI models (approximately 6GB)"
          mkdir -p "$MODEL_DIR"
          python3 << 'PYEOF'
          from huggingface_hub import snapshot_download
          import os
          model_dir = os.environ.get('MODEL_DIR', os.path.expanduser('~/.mulastudio/models'))
          print("[1/3] HeartMuLaGen...")
          snapshot_download('HeartMuLa/HeartMuLaGen', local_dir=model_dir)
          print("[2/3] HeartMuLa-oss-3B...")
          snapshot_download('HeartMuLa/HeartMuLa-oss-3B', local_dir=os.path.join(model_dir, 'HeartMuLa-oss-3B'))
          print("[3/3] HeartCodec-oss...")
          snapshot_download('HeartMuLa/HeartCodec-oss', local_dir=os.path.join(model_dir, 'HeartCodec-oss'))
          print("Complete!")
          PYEOF
          log "Models downloaded"

          step "Creating application files"
          mkdir -p "$INSTALL_DIR/app"
          curl -sL "https://raw.githubusercontent.com/saintgo7/web-music-heartlib/main/installer/app/main.py" -o "$INSTALL_DIR/app/main.py"
          log "Application files ready"

          step "Creating launcher"
          mkdir -p "$BIN_DIR"
          cat > "$BIN_DIR/mulastudio" << EOF
          #!/bin/bash
          source "$INSTALL_DIR/venv/bin/activate"
          xdg-open "http://127.0.0.1:7860" 2>/dev/null &
          python "$INSTALL_DIR/app/main.py"
          EOF
          chmod +x "$BIN_DIR/mulastudio"

          # Desktop entry
          DESKTOP_DIR="$HOME/.local/share/applications"
          mkdir -p "$DESKTOP_DIR"
          cat > "$DESKTOP_DIR/mulastudio.desktop" << EOF
          [Desktop Entry]
          Name=MuLa Studio
          Comment=AI Music Generator
          Exec=$BIN_DIR/mulastudio
          Icon=audio-x-generic
          Terminal=true
          Type=Application
          Categories=Audio;Music;
          EOF

          # Copy to desktop if exists
          for dir in "$HOME/Desktop" "$HOME/desktop"; do
              if [[ -d "$dir" ]]; then
                  cp "$DESKTOP_DIR/mulastudio.desktop" "$dir/"
                  chmod +x "$dir/mulastudio.desktop"
              fi
          done

          log "Launcher created"

          # Uninstaller
          cat > "$INSTALL_DIR/uninstall.sh" << 'EOF'
          #!/bin/bash
          echo "Uninstalling MuLa Studio..."
          rm -rf "$HOME/.mulastudio"
          rm -f "$HOME/.local/bin/mulastudio"
          rm -f "$HOME/.local/share/applications/mulastudio.desktop"
          rm -f "$HOME/Desktop/mulastudio.desktop" 2>/dev/null
          echo "Uninstall complete!"
          EOF
          chmod +x "$INSTALL_DIR/uninstall.sh"

          echo ""
          echo -e "${GREEN}${BOLD}================================================================${NC}"
          echo -e "${GREEN}${BOLD}   Installation Complete!${NC}"
          echo ""
          echo "   Run MuLa Studio:"
          echo "     1. Terminal: mulastudio"
          echo "     2. Desktop icon (if available)"
          echo ""
          echo "   Uninstall: ~/.mulastudio/uninstall.sh"
          echo -e "${GREEN}${BOLD}================================================================${NC}"

          read -p "Launch now? [Y/n] " -n 1 -r
          echo
          [[ ! $REPLY =~ ^[Nn]$ ]] && "$BIN_DIR/mulastudio"
          SCRIPT_EOF

          chmod +x installer/linux/mula_install.sh

      - name: Verify shell script syntax
        run: bash -n installer/linux/mula_install.sh

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: installer/linux/mula_install.sh
          if-no-files-found: error

  # ===========================================================================
  # Create Release
  # ===========================================================================
  create-release:
    name: Create Release
    needs: [build-windows-x64, build-windows-x86, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release

      - name: Organize release files
        run: |
          mkdir -p dist
          mv release/windows-x64-installer/MuLa_Setup_x64.exe dist/
          mv release/windows-x86-installer/MuLa_Setup_x86.exe dist/
          mv release/macos-installer/MuLa_Installer.dmg dist/
          mv release/linux-installer/mula_install.sh dist/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: MuLa Studio v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            dist/MuLa_Setup_x64.exe
            dist/MuLa_Setup_x86.exe
            dist/MuLa_Installer.dmg
            dist/mula_install.sh
            dist/checksums.txt
          body: |
            ## MuLa Studio v${{ steps.version.outputs.VERSION }}

            HeartMuLa AI Music Generator - One-Click Installer

            ### Downloads

            | Platform | File | Notes |
            |----------|------|-------|
            | Windows 64-bit | `MuLa_Setup_x64.exe` | Recommended for most users |
            | Windows 32-bit | `MuLa_Setup_x86.exe` | CPU only, slower |
            | macOS | `MuLa_Installer.dmg` | Intel & Apple Silicon |
            | Linux | `mula_install.sh` | Ubuntu, Fedora, Arch |

            ### System Requirements

            - **RAM**: 8GB minimum, 16GB recommended
            - **Storage**: 15GB free space
            - **GPU** (optional): NVIDIA RTX 2060+ for faster generation

            ### Installation

            1. Download the installer for your platform
            2. Run the installer
            3. Follow the on-screen instructions
            4. Launch MuLa Studio from desktop shortcut

            ### Documentation

            - [Installation Guide](https://music.abada.kr/tutorial)
            - [FAQ](https://music.abada.kr/faq)
            - [GitHub Issues](https://github.com/saintgo7/web-music-heartlib/issues)

            ---
            *Powered by HeartMuLa | CC BY-NC 4.0 | ABADA Inc.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
