# =============================================================================
# ABADA Music Studio - Cloudflare Workers Configuration (Production Ready)
#
# This configuration file defines the Cloudflare Workers settings
# for the ABADA Music Studio API.
#
# Documentation: https://developers.cloudflare.com/workers/wrangler/configuration
#
# Deploy command: wrangler deploy
# Dev command: wrangler dev
#
# Version: 1.0.0
# Updated: 2026-01-19
#
# SLA Targets:
#   - Uptime: 99.9%
#   - Response Time (p95): < 1s
#   - Error Rate: < 0.1%
# =============================================================================

# -----------------------------------------------------------------------------
# Basic Configuration
# -----------------------------------------------------------------------------

name = "abada-music-api"
main = "functions/api/index.js"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Account ID (set via CLOUDFLARE_ACCOUNT_ID environment variable)
# Uncomment and set your account ID if not using environment variable
# account_id = "YOUR_ACCOUNT_ID_HERE"

# -----------------------------------------------------------------------------
# Workers Routes (Production)
# Configure custom domain routing for the API
# -----------------------------------------------------------------------------

# Production routes - uncomment after DNS setup
# routes = [
#   { pattern = "music.abada.kr/api/*", zone_name = "abada.kr" }
# ]

# Or use a simple pattern:
# route = "music.abada.kr/api/*"
# zone_name = "abada.kr"

# -----------------------------------------------------------------------------
# KV Namespaces
# Storage for download statistics, gallery data, and analytics
#
# SETUP INSTRUCTIONS:
# 1. Run CLOUDFLARE_SETUP_AUTOMATION.sh to create namespaces automatically
# 2. Or manually create using:
#    wrangler kv:namespace create "STATS"
#    wrangler kv:namespace create "STATS" --preview
#    wrangler kv:namespace create "GALLERY"
#    wrangler kv:namespace create "GALLERY" --preview
#    wrangler kv:namespace create "ANALYTICS"
#    wrangler kv:namespace create "ANALYTICS" --preview
# 3. Replace PLACEHOLDER values with actual IDs
# -----------------------------------------------------------------------------

# Download Statistics Storage
[[kv_namespaces]]
binding = "STATS"
id = "PLACEHOLDER_STATS_KV_ID"
preview_id = "PLACEHOLDER_STATS_KV_PREVIEW_ID"

# Gallery Samples Storage
[[kv_namespaces]]
binding = "GALLERY"
id = "PLACEHOLDER_GALLERY_KV_ID"
preview_id = "PLACEHOLDER_GALLERY_KV_PREVIEW_ID"

# Analytics Events Storage
[[kv_namespaces]]
binding = "ANALYTICS"
id = "PLACEHOLDER_ANALYTICS_KV_ID"
preview_id = "PLACEHOLDER_ANALYTICS_KV_PREVIEW_ID"

# -----------------------------------------------------------------------------
# Environment Variables (Public)
# Non-sensitive configuration values
# -----------------------------------------------------------------------------

[vars]
ENVIRONMENT = "production"
APP_NAME = "ABADA Music Studio"
APP_VERSION = "1.0.0"
WEBSITE_URL = "https://music.abada.kr"
GITHUB_RELEASES_URL = "https://github.com/saintgo7/web-music-heartlib/releases"
GITHUB_REPO = "saintgo7/web-music-heartlib"
API_VERSION = "v1"
LOG_LEVEL = "info"
CORS_ALLOW_ALL = "true"
# Rate limiting
RATE_LIMIT_REQUESTS = "100"
RATE_LIMIT_WINDOW = "60"
# Cache settings
CACHE_TTL_STATS = "300"
CACHE_TTL_GALLERY = "3600"
# Analytics
ANALYTICS_ENABLED = "true"

# -----------------------------------------------------------------------------
# Development Environment
# Local development settings (wrangler dev)
# -----------------------------------------------------------------------------

[env.development]
name = "abada-music-api-dev"

[env.development.vars]
ENVIRONMENT = "development"
LOG_LEVEL = "debug"
CORS_ALLOW_ALL = "true"
WEBSITE_URL = "http://localhost:5173"
ANALYTICS_ENABLED = "false"

# Development KV namespaces (use preview IDs)
# Uncomment and configure after creating namespaces
# [[env.development.kv_namespaces]]
# binding = "STATS"
# id = "YOUR_STATS_KV_PREVIEW_ID"

# [[env.development.kv_namespaces]]
# binding = "GALLERY"
# id = "YOUR_GALLERY_KV_PREVIEW_ID"

# [[env.development.kv_namespaces]]
# binding = "ANALYTICS"
# id = "YOUR_ANALYTICS_KV_PREVIEW_ID"

# -----------------------------------------------------------------------------
# Staging Environment
# Pre-production testing (wrangler deploy --env staging)
# -----------------------------------------------------------------------------

[env.staging]
name = "abada-music-api-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
WEBSITE_URL = "https://staging.music.abada.kr"
LOG_LEVEL = "debug"
CORS_ALLOW_ALL = "true"
ANALYTICS_ENABLED = "true"

# Staging routes (optional)
# routes = [
#   { pattern = "staging.music.abada.kr/api/*", zone_name = "abada.kr" }
# ]

# Staging KV namespaces
# Create separate namespaces for staging environment
# [[env.staging.kv_namespaces]]
# binding = "STATS"
# id = "YOUR_STAGING_STATS_KV_ID"

# [[env.staging.kv_namespaces]]
# binding = "GALLERY"
# id = "YOUR_STAGING_GALLERY_KV_ID"

# [[env.staging.kv_namespaces]]
# binding = "ANALYTICS"
# id = "YOUR_STAGING_ANALYTICS_KV_ID"

# -----------------------------------------------------------------------------
# Production Environment
# Live production settings (wrangler deploy --env production)
# -----------------------------------------------------------------------------

[env.production]
name = "abada-music-api"

[env.production.vars]
ENVIRONMENT = "production"
LOG_LEVEL = "warn"
CORS_ALLOW_ALL = "false"
ANALYTICS_ENABLED = "true"
# Production-specific settings
RATE_LIMIT_REQUESTS = "100"
RATE_LIMIT_WINDOW = "60"
CACHE_TTL_STATS = "300"
CACHE_TTL_GALLERY = "3600"
# Error handling
ERROR_REPORTING = "true"
DEBUG_MODE = "false"

# Production routes
# routes = [
#   { pattern = "music.abada.kr/api/*", zone_name = "abada.kr" }
# ]

# Production KV namespaces (same as default)
# [[env.production.kv_namespaces]]
# binding = "STATS"
# id = "YOUR_PRODUCTION_STATS_KV_ID"
# preview_id = "YOUR_PRODUCTION_STATS_KV_PREVIEW_ID"

# [[env.production.kv_namespaces]]
# binding = "GALLERY"
# id = "YOUR_PRODUCTION_GALLERY_KV_ID"
# preview_id = "YOUR_PRODUCTION_GALLERY_KV_PREVIEW_ID"

# [[env.production.kv_namespaces]]
# binding = "ANALYTICS"
# id = "YOUR_PRODUCTION_ANALYTICS_KV_ID"
# preview_id = "YOUR_PRODUCTION_ANALYTICS_KV_PREVIEW_ID"

# -----------------------------------------------------------------------------
# Build Configuration
# Custom build settings (if needed)
# -----------------------------------------------------------------------------

[build]
# Build command (leave empty for no build step)
command = ""

# Watch directories for development mode
# watch_dir = "functions"

# Upload source maps for debugging
# upload_source_maps = true

# -----------------------------------------------------------------------------
# Triggers
# Schedule and event triggers
# -----------------------------------------------------------------------------

# Cron triggers for scheduled tasks
# [triggers]
# crons = [
#   "0 0 * * *",     # Daily at midnight UTC - cleanup old data
#   "0 */6 * * *"    # Every 6 hours - aggregate analytics
# ]

# -----------------------------------------------------------------------------
# Observability
# Logging and monitoring settings
# -----------------------------------------------------------------------------

[observability]
enabled = true

# Observability settings for production monitoring
# Logs are automatically captured and can be viewed via:
#   wrangler tail
#   wrangler tail --format=json
#
# For production monitoring, enable the following in Cloudflare Dashboard:
# - Workers Analytics
# - Real-time logs
# - Error tracking

# Log push configuration (optional - requires Logpush subscription)
# [observability.logs]
# enabled = true
# invocation_logs = true

# -----------------------------------------------------------------------------
# Limits
# Resource limits for the Worker
# -----------------------------------------------------------------------------

# CPU time limit (milliseconds)
# limits = { cpu_ms = 50 }

# -----------------------------------------------------------------------------
# Placement
# Geo-location hints for Worker placement
# -----------------------------------------------------------------------------

# Smart placement - automatically place Worker near users
# [placement]
# mode = "smart"

# -----------------------------------------------------------------------------
# Analytics Engine (Beta)
# Real-time analytics storage
# -----------------------------------------------------------------------------

# Uncomment to enable Analytics Engine
# [[analytics_engine_datasets]]
# binding = "MUSIC_ANALYTICS"

# -----------------------------------------------------------------------------
# Durable Objects (Optional)
# For stateful applications
# -----------------------------------------------------------------------------

# [[durable_objects.bindings]]
# name = "RATE_LIMITER"
# class_name = "RateLimiter"

# [[migrations]]
# tag = "v1"
# new_classes = ["RateLimiter"]

# -----------------------------------------------------------------------------
# AI Binding (Optional)
# Workers AI integration
# -----------------------------------------------------------------------------

# [ai]
# binding = "AI"

# -----------------------------------------------------------------------------
# R2 Storage (Optional)
# Object storage for large files
# -----------------------------------------------------------------------------

# [[r2_buckets]]
# binding = "MUSIC_FILES"
# bucket_name = "abada-music-files"

# -----------------------------------------------------------------------------
# Secrets (Reference Only)
# These should be set via wrangler secret put, NOT in this file
#
# Required secrets:
#   - ADMIN_API_KEY: API key for admin endpoints (gallery management)
#
# Set using:
#   wrangler secret put ADMIN_API_KEY
#   wrangler secret put ADMIN_API_KEY --env staging
#   wrangler secret put ADMIN_API_KEY --env production
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Usage Notes
# -----------------------------------------------------------------------------
#
# 1. FIRST-TIME SETUP:
#    a. Run the automated setup script:
#       ./scripts/CLOUDFLARE_SETUP_AUTOMATION.sh
#
#    b. Or manually create KV namespaces:
#       wrangler kv:namespace create "STATS"
#       wrangler kv:namespace create "STATS" --preview
#       wrangler kv:namespace create "GALLERY"
#       wrangler kv:namespace create "GALLERY" --preview
#       wrangler kv:namespace create "ANALYTICS"
#       wrangler kv:namespace create "ANALYTICS" --preview
#
#    c. Update this file with the namespace IDs
#
#    d. Set secrets:
#       wrangler secret put ADMIN_API_KEY
#
#    e. Deploy:
#       wrangler deploy
#
# 2. DEVELOPMENT:
#    wrangler dev
#    # Opens local development server at http://localhost:8787
#
# 3. DEPLOY TO SPECIFIC ENVIRONMENT:
#    wrangler deploy                    # Default (production)
#    wrangler deploy --env staging      # Staging
#    wrangler deploy --env production   # Production (explicit)
#
# 4. VIEW LOGS:
#    wrangler tail
#    wrangler tail --env production
#    wrangler tail --format=json
#
# 5. MANAGE KV DATA:
#    # List all keys
#    wrangler kv:key list --namespace-id=YOUR_KV_ID
#
#    # Get a key
#    wrangler kv:key get --namespace-id=YOUR_KV_ID "key"
#
#    # Set a key
#    wrangler kv:key put --namespace-id=YOUR_KV_ID "key" "value"
#
#    # Delete a key
#    wrangler kv:key delete --namespace-id=YOUR_KV_ID "key"
#
# 6. ROLLBACK:
#    wrangler rollback
#    # Or use Cloudflare Dashboard to select specific version
#
# 7. VIEW DEPLOYMENTS:
#    wrangler deployments list
#    wrangler deployments view <deployment-id>
#
# =============================================================================
